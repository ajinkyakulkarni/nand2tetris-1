#!/bin/bash

function usage {
    printf "Usage: $0 <script.tst>\n"
    printf "Tests the script passed as argument, watching for source file changes.\n"
}

if [ "$#" -ne 1 ] || [ "$1" == "-h" ] || [ "$1" == "-help" ] || [ "$1" == "--help" ]; then
    usage
    exit 1
fi

command -v fswatch >/dev/null 2>&1 || {
    printf "`fswatch` is required: https://github.com/emcrisostomo/fswatch\n"
    exit 1
}

cd $(dirname "${0}")

testfilepath="$1"

function test {
    ./test "$testfilepath"
}

printf "Watching for source file changes...\n\n"

test
fswatch -e ".*" -i "\.asm$" -i "\.hdl$" . | (while read; do printf "\n"; test; done)
